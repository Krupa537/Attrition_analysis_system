name: PR Quality Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install pytest-cov flake8 black
    
    - name: Install Node dependencies
      run: |
        cd frontend
        npm install
    
    - name: Check Python formatting
      run: |
        black --check backend/app --diff
      continue-on-error: true
    
    - name: Lint Python
      run: |
        flake8 backend/app --max-line-length=127 --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: Run backend tests
      run: |
        pytest backend/tests -v --tb=short
    
    - name: Run frontend tests
      run: |
        cd frontend
        npm test -- --run
    
    - name: Check for console errors in builds
      run: |
        cd frontend
        npm run build 2>&1 | tee build.log
        if grep -i "error\|warning" build.log; then
          echo "‚ö†Ô∏è Build warnings found"
        fi
      continue-on-error: true

  # Size check
  size-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check frontend bundle size
      uses: preactjs/compressed-size-action@v2
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        build-script: "build"
        compression: brotli
        strip-hash: true
      continue-on-error: true
    
    - name: Check diff size
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const changes = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          let addedLines = 0;
          let removedLines = 0;
          
          changes.data.forEach(file => {
            addedLines += file.additions;
            removedLines += file.deletions;
          });
          
          console.log(`üìä Changes: +${addedLines} -${removedLines}`);
          
          if (addedLines > 1000) {
            console.log('‚ö†Ô∏è Large PR - consider breaking into smaller PRs');
          }

  # Documentation check
  docs-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for updated docs
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const changes = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const hasCodeChanges = changes.data.some(f => 
            (f.filename.includes('backend/') || f.filename.includes('frontend/')) &&
            (f.filename.endsWith('.py') || f.filename.endsWith('.jsx') || f.filename.endsWith('.js'))
          );
          
          const hasDocChanges = changes.data.some(f => 
            f.filename.endsWith('.md')
          );
          
          if (hasCodeChanges && !hasDocChanges) {
            console.log('‚ö†Ô∏è Code changed but no documentation updates');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'üìù Remember to update documentation if the functionality has changed!'
            });
          }

  # Comment on PR
  comment-pr:
    needs: [pr-quality]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Comment PR results
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ needs.pr-quality.result }}';
          const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `${emoji} Quality checks ${status === 'success' ? 'passed' : 'failed'}`
          });
